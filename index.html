<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚é–“å‰²ç®¡ç†ã‚¢ãƒ—ãƒª - è‡ªå‹•åŒæœŸç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            font-size: 14px;
        }
        
        .sync-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }
        
        .sync-indicator.offline {
            background: #f87171;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .content {
            padding: 30px;
        }
        
        .view-section {
            display: none;
        }
        
        .view-section.active {
            display: block;
        }
        
        /* æ—¥åˆ¥è¡¨ç¤ºãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .day-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .day-nav button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .day-nav button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .day-nav h2 {
            font-size: 24px;
            color: #333;
        }
        
        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .date-selector {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .date-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #495057;
        }
        
        .date-selector input {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .date-selector input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        /* æ—¥åˆ¥è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        .schedule-display {
            display: grid;
            gap: 10px;
        }
        
        .schedule-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .schedule-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .schedule-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .period-badge {
            min-width: 60px;
            padding: 8px 12px;
            background: #667eea;
            color: white;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
        }
        
        .class-badge {
            flex: 1;
            padding: 10px 15px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            text-align: center;
        }
        
        .empty-class {
            background: #adb5bd !important;
            color: white;
        }
        
        .schedule-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .schedule-controls select {
            flex: 1;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .memo-section {
            margin-top: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        
        .memo-section input[type="text"] {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
        }
        
        .memo-section input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* é€±é–“è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        .week-table-container {
            overflow-x: auto;
        }
        
        .week-table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .week-table th {
            background: #667eea;
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
        }
        
        .week-table td {
            padding: 12px 10px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        
        .week-table .period-cell {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .week-header {
            font-size: 12px;
            font-weight: normal;
            opacity: 0.9;
        }
        
        /* åŸºæœ¬æ™‚é–“å‰²ç·¨é›†ã‚¹ã‚¿ã‚¤ãƒ« */
        .edit-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .edit-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .edit-table td {
            padding: 8px;
            border: 1px solid #dee2e6;
        }
        
        .edit-table select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .edit-table select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* æˆæ¥­å¤‰æ›´ç·¨é›†ã‚¹ã‚¿ã‚¤ãƒ« */
        .change-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .change-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .change-table td {
            padding: 12px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        
        .change-table input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* è‰²è¨­å®šã‚¹ã‚¿ã‚¤ãƒ« */
        .color-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .color-item {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .color-item label {
            font-weight: 600;
            color: #495057;
        }
        
        .color-item input[type="color"] {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        /* ä¿å­˜ãƒœã‚¿ãƒ³ */
        .save-button {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 30px auto 0;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .save-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .save-button:active {
            transform: translateY(0);
        }
        
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .message {
            display: none;
            padding: 15px;
            margin-top: 20px;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            text-align: center;
        }
        
        .message.show {
            display: block;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .content {
                padding: 15px;
            }
            
            .tab {
                font-size: 14px;
                padding: 12px 8px;
                min-width: 100px;
            }
            
            .day-nav {
                flex-direction: column;
                gap: 10px;
            }
            
            .day-nav h2 {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š æ™‚é–“å‰²ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
            <p>è‹±èªç§‘ | é‡‘å­å…ˆç”Ÿç”¨ | è‡ªå‹•åŒæœŸå¯¾å¿œ</p>
            <div class="sync-status">
                <div class="sync-indicator" id="syncIndicator"></div>
                <span id="syncStatus">æ¥ç¶šä¸­...</span>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('day')">ğŸ“… æ—¥åˆ¥è¡¨ç¤º</button>
            <button class="tab" onclick="switchTab('week')">ğŸ“Š é€±åˆ¥è¡¨ç¤º</button>
            <button class="tab" onclick="switchTab('base')">âš™ï¸ åŸºæœ¬æ™‚é–“å‰²</button>
            <button class="tab" onclick="switchTab('change')">ğŸ”„ æˆæ¥­å¤‰æ›´</button>
            <button class="tab" onclick="switchTab('colors')">ğŸ¨ è‰²è¨­å®š</button>
        </div>
        
        <div class="content">
            <!-- æ—¥åˆ¥è¡¨ç¤º -->
            <div id="dayView" class="view-section active">
                <div class="day-nav">
                    <button onclick="previousDay()">â† å‰æ—¥</button>
                    <h2 id="displayDateTitle"></h2>
                    <button onclick="nextDay()">ç¿Œæ—¥ â†’</button>
                </div>
                <div class="schedule-display" id="scheduleDisplay"></div>
            </div>
            
            <!-- é€±åˆ¥è¡¨ç¤º -->
            <div id="weekView" class="view-section">
                <div class="date-selector">
                    <label for="weekStartDate">é€±ã®é–‹å§‹æ—¥ï¼ˆæœˆæ›œæ—¥ï¼‰ã‚’é¸æŠï¼š</label>
                    <input type="date" id="weekStartDate">
                    <button class="btn btn-primary" onclick="displayWeekSchedule()">è¡¨ç¤º</button>
                </div>
                <h2 id="weekDisplayTitle" style="margin-bottom: 20px; color: #333;"></h2>
                <div class="week-table-container">
                    <table class="week-table" id="weekScheduleTable"></table>
                </div>
            </div>
            
            <!-- åŸºæœ¬æ™‚é–“å‰²ç·¨é›† -->
            <div id="baseView" class="view-section">
                <h2 style="margin-bottom: 20px; color: #333;">åŸºæœ¬æ™‚é–“å‰²ã®è¨­å®š</h2>
                <table class="edit-table" id="baseTimetable">
                    <thead>
                        <tr>
                            <th>æ™‚é™</th>
                            <th>æœˆæ›œæ—¥</th>
                            <th>ç«æ›œæ—¥</th>
                            <th>æ°´æ›œæ—¥</th>
                            <th>æœ¨æ›œæ—¥</th>
                            <th>é‡‘æ›œæ—¥</th>
                        </tr>
                    </thead>
                    <tbody id="baseTimetableBody"></tbody>
                </table>
                <button class="save-button" onclick="saveBaseTimetable()">ğŸ’¾ åŸºæœ¬æ™‚é–“å‰²ã‚’ä¿å­˜</button>
                <div id="baseMessage" class="message">ä¿å­˜ã—ã¾ã—ãŸï¼</div>
            </div>
            
            <!-- æˆæ¥­å¤‰æ›´ç·¨é›† -->
            <div id="changeView" class="view-section">
                <h2 style="margin-bottom: 20px; color: #333;">æˆæ¥­å¤‰æ›´ã®è¨­å®š</h2>
                <div class="date-selector">
                    <label for="changeDate">å¤‰æ›´ã™ã‚‹æ—¥ä»˜ã‚’é¸æŠï¼š</label>
                    <input type="date" id="changeDate">
                    <button class="btn btn-primary" onclick="loadDateTimetable()">èª­ã¿è¾¼ã¿</button>
                </div>
                <div id="selectedDateInfo" style="display: none; margin-bottom: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px;">
                    <h3 style="color: #333;">é¸æŠä¸­: <span id="selectedDateText"></span></h3>
                    <p style="color: #6c757d; margin-top: 5px;">å¤‰æ›´ã—ãŸã„æ™‚é™ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã€ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                </div>
                <table class="change-table" id="changeTimetable">
                    <thead>
                        <tr>
                            <th>æ™‚é™</th>
                            <th>å¤‰æ›´</th>
                            <th>ã‚¯ãƒ©ã‚¹</th>
                        </tr>
                    </thead>
                    <tbody id="changeTimetableBody"></tbody>
                </table>
                <button class="save-button" onclick="saveChangeTimetable()">ğŸ’¾ æˆæ¥­å¤‰æ›´ã‚’ä¿å­˜</button>
                <button class="save-button" style="background: #6c757d; margin-top: 10px;" onclick="clearAllChanges()">ğŸ—‘ï¸ ã“ã®æ—¥ã®å¤‰æ›´ã‚’ã‚¯ãƒªã‚¢</button>
                <div id="changeMessage" class="message">ä¿å­˜ã—ã¾ã—ãŸï¼</div>
            </div>
            
            <!-- è‰²è¨­å®š -->
            <div id="colorsView" class="view-section">
                <h2 style="margin-bottom: 20px; color: #333;">ã‚¯ãƒ©ã‚¹åˆ¥è‰²è¨­å®š</h2>
                <div class="color-settings" id="colorSettings"></div>
                <button class="save-button" onclick="saveColors()">ğŸ’¾ è‰²è¨­å®šã‚’ä¿å­˜</button>
                <div id="colorMessage" class="message">ä¿å­˜ã—ã¾ã—ãŸï¼</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebaseè¨­å®šï¼ˆåŸ‹ã‚è¾¼ã¿æ¸ˆã¿ï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyDOqoM1koJVXGmBB-LaTe9MczDm02zO9M",
            authDomain: "time-schedule-49fdc.firebaseapp.com",
            projectId: "time-schedule-49fdc",
            storageBucket: "time-schedule-49fdc.firebasestorage.app",
            messagingSenderId: "1095037674644",
            appId: "1:1095037674644:web:90c0ee33627fa53be40081"
        };
        
        // ã‚¯ãƒ©ã‚¹ä¸€è¦§
        const classes = ['', '1-1', '1-2', '2-1', '3-1'];
        const periods = 7;
        const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘'];
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è‰²è¨­å®š
        const defaultColors = {
            '1-1': '#667eea',
            '1-2': '#f5576c',
            '2-1': '#00f2fe',
            '3-1': '#38f9d7'
        };
        
        // Firebaseé–¢é€£
        let db = null;
        let isFirebaseConfigured = false;
        let isSyncing = false;
        let deviceId = localStorage.getItem('deviceId') || generateDeviceId();
        
        // ç¾åœ¨ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
        let currentView = 'day';
        
        // ç¾åœ¨ã®è¡¨ç¤ºæ—¥ä»˜ï¼ˆæ—¥åˆ¥è¡¨ç¤ºç”¨ï¼‰
        let currentDisplayDate = null;
        
        // æ—¥æœ¬æ™‚é–“ã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        function getTodayJST() {
            const now = new Date();
            // æ—¥æœ¬æ™‚é–“ï¼ˆUTC+9ï¼‰ã«å¤‰æ›
            const jstOffset = 9 * 60; // 9æ™‚é–“ = 540åˆ†
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const jstTime = new Date(utc + (jstOffset * 60000));
            
            const year = jstTime.getFullYear();
            const month = String(jstTime.getMonth() + 1).padStart(2, '0');
            const day = String(jstTime.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }
        
        // ãƒ‡ãƒã‚¤ã‚¹IDã‚’ç”Ÿæˆ
        function generateDeviceId() {
            const id = 'device_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('deviceId', id);
            return id;
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹...');
            
            // Firebaseã‚’è‡ªå‹•åˆæœŸåŒ–
            initializeFirebase(firebaseConfig);
            
            // UIåˆæœŸåŒ–
            initBaseTimetable();
            initChangeTimetable();
            loadColors();
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨­å®šï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰
            const today = getTodayJST();
            console.log('ä»Šæ—¥ã®æ—¥ä»˜ï¼ˆJSTï¼‰:', today);
            
            currentDisplayDate = today;
            document.getElementById('changeDate').value = today;
            document.getElementById('weekStartDate').value = getMonday(today);
            
            // åˆå›è¡¨ç¤º
            displayDaySchedule();
        });
        
        // æœˆæ›œæ—¥ã‚’å–å¾—
        function getMonday(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const dayOfWeek = date.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            date.setDate(date.getDate() + diff);
            
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        
        // å‰æ—¥ã¸
        function previousDay() {
            const [year, month, day] = currentDisplayDate.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            date.setDate(date.getDate() - 1);
            currentDisplayDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            displayDaySchedule();
        }
        
        // ç¿Œæ—¥ã¸
        function nextDay() {
            const [year, month, day] = currentDisplayDate.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            date.setDate(date.getDate() + 1);
            currentDisplayDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            displayDaySchedule();
        }
        
        // Firebaseã‚’åˆæœŸåŒ–
        function initializeFirebase(config) {
            console.log('FirebaseåˆæœŸåŒ–é–‹å§‹...');
            
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                    console.log('FirebaseåˆæœŸåŒ–æˆåŠŸ');
                }
                
                db = firebase.firestore();
                console.log('Firestoreæ¥ç¶šæˆåŠŸ');
                
                isFirebaseConfigured = true;
                
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã‚’æœ‰åŠ¹åŒ–
                db.enablePersistence()
                    .then(() => {
                        console.log('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œæœ‰åŠ¹åŒ–æˆåŠŸ');
                    })
                    .catch((err) => {
                        console.warn('Persistenceæœ‰åŠ¹åŒ–ã‚¨ãƒ©ãƒ¼:', err);
                    });
                
                updateSyncStatus('online', 'åŒæœŸä¸­');
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’Firebaseã‹ã‚‰èª­ã¿è¾¼ã¿
                syncFromFirebase();
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚’è¨­å®š
                setupRealtimeSync();
                
            } catch (error) {
                console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateSyncStatus('offline', 'Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message);
                isFirebaseConfigured = false;
            }
        }
        
        // åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        function updateSyncStatus(status, message) {
            const indicator = document.getElementById('syncIndicator');
            const statusText = document.getElementById('syncStatus');
            
            if (indicator && statusText) {
                if (status === 'online') {
                    indicator.classList.remove('offline');
                } else {
                    indicator.classList.add('offline');
                }
                
                statusText.textContent = message;
            }
        }
        
        // Firebaseã‹ã‚‰åŒæœŸ
        async function syncFromFirebase() {
            if (!isFirebaseConfigured || isSyncing) return;
            
            isSyncing = true;
            console.log('FirebaseåŒæœŸé–‹å§‹...');
            
            try {
                // åŸºæœ¬æ™‚é–“å‰²ã‚’å–å¾—
                const baseDoc = await db.collection('timetables').doc('base').get();
                if (baseDoc.exists) {
                    const data = baseDoc.data();
                    localStorage.setItem('baseTimetable', JSON.stringify(data.schedule || {}));
                    console.log('åŸºæœ¬æ™‚é–“å‰²ã‚’åŒæœŸã—ã¾ã—ãŸ');
                }
                
                // æˆæ¥­å¤‰æ›´ã‚’å–å¾—
                const changesDoc = await db.collection('timetables').doc('changes').get();
                if (changesDoc.exists) {
                    const data = changesDoc.data();
                    localStorage.setItem('timetableChanges', JSON.stringify(data.changes || {}));
                    console.log('æˆæ¥­å¤‰æ›´ã‚’åŒæœŸã—ã¾ã—ãŸ');
                }
                
                // ãƒ¡ãƒ¢ã‚’å–å¾—
                const memosDoc = await db.collection('timetables').doc('memos').get();
                if (memosDoc.exists) {
                    const data = memosDoc.data();
                    localStorage.setItem('classMemos', JSON.stringify(data.memos || {}));
                    console.log('ãƒ¡ãƒ¢ã‚’åŒæœŸã—ã¾ã—ãŸ');
                }
                
                // è‰²è¨­å®šã‚’å–å¾—
                const colorsDoc = await db.collection('timetables').doc('colors').get();
                if (colorsDoc.exists) {
                    const data = colorsDoc.data();
                    localStorage.setItem('classColors', JSON.stringify(data.colors || defaultColors));
                    console.log('è‰²è¨­å®šã‚’åŒæœŸã—ã¾ã—ãŸ');
                }
                
                updateSyncStatus('online', 'åŒæœŸå®Œäº†');
                
                // è¡¨ç¤ºã‚’æ›´æ–°
                if (currentView === 'day') {
                    displayDaySchedule();
                } else if (currentView === 'week') {
                    displayWeekSchedule();
                }
                
            } catch (error) {
                console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                updateSyncStatus('offline', 'åŒæœŸã‚¨ãƒ©ãƒ¼: ' + error.message);
            } finally {
                isSyncing = false;
            }
        }
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚’è¨­å®š
        let lastSyncTime = Date.now();
        let isFirstSync = true;
        
        function setupRealtimeSync() {
            if (!isFirebaseConfigured) return;
            
            console.log('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚’è¨­å®šä¸­...');
            
            // åŸºæœ¬æ™‚é–“å‰²ã®å¤‰æ›´ã‚’ç›£è¦–
            db.collection('timetables').doc('base').onSnapshot((doc) => {
                if (isFirstSync) {
                    console.log('åˆå›ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ãªã—ï¼‰');
                    return;
                }
                
                if (doc.exists) {
                    const data = doc.data();
                    const now = Date.now();
                    
                    if (data.lastModifiedBy !== deviceId && (now - lastSyncTime) > 3000) {
                        console.log('åŸºæœ¬æ™‚é–“å‰²ãŒä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§æ›´æ–°ã•ã‚Œã¾ã—ãŸ');
                        localStorage.setItem('baseTimetable', JSON.stringify(data.schedule || {}));
                        lastSyncTime = now;
                        
                        if (currentView === 'day' || currentView === 'week' || currentView === 'base') {
                            updateDisplay();
                        }
                    }
                }
            });
            
            // æˆæ¥­å¤‰æ›´ã®å¤‰æ›´ã‚’ç›£è¦–
            db.collection('timetables').doc('changes').onSnapshot((doc) => {
                if (isFirstSync) {
                    return;
                }
                
                if (doc.exists) {
                    const data = doc.data();
                    const now = Date.now();
                    
                    if (data.lastModifiedBy !== deviceId && (now - lastSyncTime) > 3000) {
                        console.log('æˆæ¥­å¤‰æ›´ãŒä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§æ›´æ–°ã•ã‚Œã¾ã—ãŸ');
                        localStorage.setItem('timetableChanges', JSON.stringify(data.changes || {}));
                        lastSyncTime = now;
                        
                        if (currentView === 'day' || currentView === 'week' || currentView === 'change') {
                            updateDisplay();
                        }
                    }
                }
            });
            
            // ãƒ¡ãƒ¢ã®å¤‰æ›´ã‚’ç›£è¦–
            db.collection('timetables').doc('memos').onSnapshot((doc) => {
                if (isFirstSync) {
                    return;
                }
                
                if (doc.exists) {
                    const data = doc.data();
                    const now = Date.now();
                    
                    if (data.lastModifiedBy !== deviceId && (now - lastSyncTime) > 3000) {
                        console.log('ãƒ¡ãƒ¢ãŒä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§æ›´æ–°ã•ã‚Œã¾ã—ãŸ');
                        localStorage.setItem('classMemos', JSON.stringify(data.memos || {}));
                        lastSyncTime = now;
                        
                        if (currentView === 'day') {
                            updateDisplay();
                        }
                    }
                }
            });
            
            // è‰²è¨­å®šã®å¤‰æ›´ã‚’ç›£è¦–
            db.collection('timetables').doc('colors').onSnapshot((doc) => {
                if (isFirstSync) {
                    isFirstSync = false;
                    return;
                }
                
                if (doc.exists) {
                    const data = doc.data();
                    const now = Date.now();
                    
                    if (data.lastModifiedBy !== deviceId && (now - lastSyncTime) > 3000) {
                        console.log('è‰²è¨­å®šãŒä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§æ›´æ–°ã•ã‚Œã¾ã—ãŸ');
                        localStorage.setItem('classColors', JSON.stringify(data.colors || defaultColors));
                        lastSyncTime = now;
                        
                        if (currentView === 'day' || currentView === 'week' || currentView === 'colors') {
                            updateDisplay();
                        }
                    }
                }
            });
        }
        
        // è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ãªã—ï¼‰
        function updateDisplay() {
            if (currentView === 'day') {
                displayDaySchedule();
            } else if (currentView === 'week') {
                displayWeekSchedule();
            } else if (currentView === 'base') {
                initBaseTimetable();
            } else if (currentView === 'change') {
                loadDateTimetable();
            } else if (currentView === 'colors') {
                loadColors();
            }
        }
        
        // Firebaseã«ä¿å­˜
        async function saveToFirebase(docName, dataObj) {
            if (!isFirebaseConfigured) {
                console.warn('FirebaseãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return false;
            }
            
            try {
                await db.collection('timetables').doc(docName).set({
                    ...dataObj,
                    lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                    lastModifiedBy: deviceId
                });
                console.log(`${docName}ã‚’Firebaseã«ä¿å­˜ã—ã¾ã—ãŸ`);
                updateSyncStatus('online', 'ä¿å­˜å®Œäº†');
                return true;
            } catch (error) {
                console.error('Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                updateSyncStatus('offline', 'ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
                return false;
            }
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(viewName) {
            currentView = viewName;
            
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã¨ãƒ“ãƒ¥ãƒ¼ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(section => section.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã¨ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            event.target.classList.add('active');
            document.getElementById(viewName + 'View').classList.add('active');
            
            // ãƒ“ãƒ¥ãƒ¼ã«å¿œã˜ã¦è¡¨ç¤ºã‚’æ›´æ–°
            if (viewName === 'day') {
                displayDaySchedule();
            } else if (viewName === 'week') {
                displayWeekSchedule();
            }
        }
        
        // åŸºæœ¬æ™‚é–“å‰²ã®åˆæœŸåŒ–
        function initBaseTimetable() {
            const tbody = document.getElementById('baseTimetableBody');
            tbody.innerHTML = '';
            
            const saved = JSON.parse(localStorage.getItem('baseTimetable') || '{}');
            
            for (let i = 0; i < periods; i++) {
                const row = tbody.insertRow();
                const cellPeriod = row.insertCell(0);
                cellPeriod.textContent = `${i + 1}é™`;
                cellPeriod.style.fontWeight = '600';
                cellPeriod.style.textAlign = 'center';
                cellPeriod.style.background = '#f8f9fa';
                
                for (let j = 0; j < 5; j++) {
                    const cell = row.insertCell(j + 1);
                    const select = document.createElement('select');
                    select.id = `base_${days[j]}_${i}`;
                    
                    classes.forEach(className => {
                        const option = document.createElement('option');
                        option.value = className;
                        option.textContent = className || 'â€”';
                        select.appendChild(option);
                    });
                    
                    if (saved[days[j]] && saved[days[j]][i]) {
                        select.value = saved[days[j]][i];
                    }
                    
                    cell.appendChild(select);
                }
            }
        }
        
        // åŸºæœ¬æ™‚é–“å‰²ã®ä¿å­˜
        async function saveBaseTimetable() {
            const timetable = {};
            
            days.forEach(day => {
                timetable[day] = [];
                for (let i = 0; i < periods; i++) {
                    const select = document.getElementById(`base_${day}_${i}`);
                    timetable[day][i] = select.value;
                }
            });
            
            localStorage.setItem('baseTimetable', JSON.stringify(timetable));
            await saveToFirebase('base', { schedule: timetable });
            showMessage('baseMessage');
        }
        
        // æˆæ¥­å¤‰æ›´ã®åˆæœŸåŒ–
        function initChangeTimetable() {
            const tbody = document.getElementById('changeTimetableBody');
            tbody.innerHTML = '';
            
            for (let i = 0; i < periods; i++) {
                const row = tbody.insertRow();
                const cellPeriod = row.insertCell(0);
                const cellCheck = row.insertCell(1);
                const cellClass = row.insertCell(2);
                
                cellPeriod.textContent = `${i + 1}é™`;
                cellPeriod.style.fontWeight = '600';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `changed_${i + 1}`;
                cellCheck.appendChild(checkbox);
                
                const select = document.createElement('select');
                select.id = `change_${i + 1}`;
                classes.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className || 'â€”';
                    select.appendChild(option);
                });
                cellClass.appendChild(select);
            }
        }
        
        // æŒ‡å®šæ—¥ã®æ™‚é–“å‰²ã‚’å–å¾—
        function getTimetableForDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const dayOfWeek = date.getDay();
            
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return Array(periods).fill('');
            }
            
            const dayIndex = dayOfWeek - 1;
            const dayName = days[dayIndex];
            
            const baseTimetable = JSON.parse(localStorage.getItem('baseTimetable') || '{}');
            const changes = JSON.parse(localStorage.getItem('timetableChanges') || '{}');
            
            const schedule = Array(periods).fill('');
            
            if (baseTimetable[dayName] && Array.isArray(baseTimetable[dayName])) {
                baseTimetable[dayName].forEach((cls, index) => {
                    if (index < periods) {
                        schedule[index] = cls || '';
                    }
                });
            }
            
            if (changes[dateStr] && Array.isArray(changes[dateStr])) {
                changes[dateStr].forEach((change, index) => {
                    if (change !== null && change !== undefined && index < periods) {
                        schedule[index] = change;
                    }
                });
            }
            
            return schedule;
        }
        
        // æŒ‡å®šæ—¥ã®æ™‚é–“å‰²ã‚’èª­ã¿è¾¼ã¿
        function loadDateTimetable() {
            const dateInput = document.getElementById('changeDate');
            const selectedDate = dateInput.value;
            
            if (!selectedDate) {
                alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const dateInfo = document.getElementById('selectedDateInfo');
            const dateText = document.getElementById('selectedDateText');
            const [year, month, day] = selectedDate.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
            dateText.textContent = `${selectedDate} (${dayOfWeek})`;
            dateInfo.style.display = 'block';
            
            const schedule = getTimetableForDate(selectedDate);
            const changes = JSON.parse(localStorage.getItem('timetableChanges') || '{}');
            const dateChanges = changes[selectedDate] || {};
            
            for (let i = 1; i <= periods; i++) {
                const select = document.getElementById(`change_${i}`);
                const checkbox = document.getElementById(`changed_${i}`);
                
                if (select) {
                    select.value = schedule[i - 1] || '';
                }
                
                if (checkbox) {
                    checkbox.checked = dateChanges[i - 1] !== null && dateChanges[i - 1] !== undefined;
                }
            }
        }
        
        // æˆæ¥­å¤‰æ›´ã‚’ä¿å­˜
        async function saveChangeTimetable() {
            const dateInput = document.getElementById('changeDate');
            const selectedDate = dateInput.value;
            
            if (!selectedDate) {
                alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const changes = JSON.parse(localStorage.getItem('timetableChanges') || '{}');
            
            if (!changes[selectedDate]) {
                changes[selectedDate] = Array(periods).fill(null);
            }
            
            for (let i = 1; i <= periods; i++) {
                const checkbox = document.getElementById(`changed_${i}`);
                const select = document.getElementById(`change_${i}`);
                
                if (checkbox && checkbox.checked && select) {
                    changes[selectedDate][i - 1] = select.value;
                } else {
                    changes[selectedDate][i - 1] = null;
                }
            }
            
            if (changes[selectedDate].every(item => item === null)) {
                delete changes[selectedDate];
            }
            
            localStorage.setItem('timetableChanges', JSON.stringify(changes));
            await saveToFirebase('changes', { changes: changes });
            showMessage('changeMessage');
        }
        
        // ã™ã¹ã¦ã®å¤‰æ›´ã‚’ã‚¯ãƒªã‚¢
        async function clearAllChanges() {
            if (confirm('ã“ã®æ—¥ã®æˆæ¥­å¤‰æ›´ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                const dateInput = document.getElementById('changeDate');
                const selectedDate = dateInput.value;
                
                if (selectedDate) {
                    const changes = JSON.parse(localStorage.getItem('timetableChanges') || '{}');
                    delete changes[selectedDate];
                    localStorage.setItem('timetableChanges', JSON.stringify(changes));
                    await saveToFirebase('changes', { changes: changes });
                    loadDateTimetable();
                    showMessage('changeMessage');
                }
            }
        }
        
        // æ—¥åˆ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¡¨ç¤º
        function displayDaySchedule() {
            const selectedDate = currentDisplayDate;
            
            const [year, month, day] = selectedDate.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
            
            const title = document.getElementById('displayDateTitle');
            title.textContent = `${selectedDate} (${dayOfWeek})`;
            
            const schedule = getTimetableForDate(selectedDate);
            const display = document.getElementById('scheduleDisplay');
            display.innerHTML = '';
            
            if (dayOfWeek === 'åœŸ' || dayOfWeek === 'æ—¥') {
                display.innerHTML = '<div style="padding: 40px; text-align: center; color: #6c757d;"><h3>ã“ã®æ—¥ã¯æˆæ¥­ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆåœŸæ—¥ï¼‰</h3></div>';
                return;
            }
            
            const colors = JSON.parse(localStorage.getItem('classColors') || JSON.stringify(defaultColors));
            const memos = JSON.parse(localStorage.getItem('classMemos') || '{}');
            const changes = JSON.parse(localStorage.getItem('timetableChanges') || '{}');
            const dateChanges = changes[selectedDate] || {};
            
            for (let i = 0; i < periods; i++) {
                const cls = schedule[i] || '';
                const item = document.createElement('div');
                item.className = 'schedule-item';
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ï¼ˆæ™‚é™ã¨ã‚¯ãƒ©ã‚¹ï¼‰
                const header = document.createElement('div');
                header.className = 'schedule-header';
                
                const badge = document.createElement('div');
                badge.className = 'period-badge';
                badge.textContent = `${i + 1}é™`;
                
                const classInfo = document.createElement('div');
                classInfo.className = 'class-badge';
                
                if (cls) {
                    classInfo.textContent = `è‹±èª - ${cls}`;
                    classInfo.style.background = colors[cls] || defaultColors[cls] || '#6c757d';
                } else {
                    classInfo.textContent = 'ç©ºãã‚³ãƒ';
                    classInfo.classList.add('empty-class');
                }
                
                header.appendChild(badge);
                header.appendChild(classInfo);
                item.appendChild(header);
                
                // æˆæ¥­å¤‰æ›´ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
                const controls = document.createElement('div');
                controls.className = 'schedule-controls';
                
                const changeSelect = document.createElement('select');
                changeSelect.id = `day_change_${i}`;
                changeSelect.style.display = dateChanges[i] !== null && dateChanges[i] !== undefined ? 'block' : 'none';
                
                classes.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className || 'â€”';
                    changeSelect.appendChild(option);
                });
                
                if (dateChanges[i] !== null && dateChanges[i] !== undefined) {
                    changeSelect.value = dateChanges[i];
                }
                
                const changeBtn = document.createElement('button');
                changeBtn.className = 'btn btn-secondary btn-small';
                changeBtn.textContent = dateChanges[i] !== null && dateChanges[i] !== undefined ? 'å…ƒã«æˆ»ã™' : 'å¤‰æ›´';
                changeBtn.onclick = () => toggleDayChange(selectedDate, i);
                
                const saveBtn = document.createElement('button');
                saveBtn.className = 'btn btn-primary btn-small';
                saveBtn.textContent = 'ä¿å­˜';
                saveBtn.style.display = dateChanges[i] !== null && dateChanges[i] !== undefined ? 'inline-block' : 'none';
                saveBtn.onclick = () => saveDayChange(selectedDate, i);
                
                controls.appendChild(changeSelect);
                controls.appendChild(changeBtn);
                controls.appendChild(saveBtn);
                item.appendChild(controls);
                
                // ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                const memoSection = document.createElement('div');
                memoSection.className = 'memo-section';
                
                const memoKey = `${selectedDate}_${i}`;
                const memoText = memos[memoKey] || '';
                
                const memoInput = document.createElement('input');
                memoInput.type = 'text';
                memoInput.id = `memo_${i}`;
                memoInput.placeholder = 'ãƒ¡ãƒ¢ã‚’å…¥åŠ›...';
                memoInput.value = memoText;
                memoInput.onblur = () => saveMemo(selectedDate, i);
                
                memoSection.appendChild(memoInput);
                item.appendChild(memoSection);
                
                display.appendChild(item);
            }
        }
        
        // æ—¥åˆ¥è¡¨ç¤ºã§ã®æˆæ¥­å¤‰æ›´ãƒˆã‚°ãƒ«
        function toggleDayChange(dateStr, periodIndex) {
            const changes = JSON.parse(localStorage.getItem('timetableChanges') || '{}');
            
            if (!changes[dateStr]) {
                changes[dateStr] = Array(periods).fill(null);
            }
            
            if (changes[dateStr][periodIndex] !== null && changes[dateStr][periodIndex] !== undefined) {
                // å…ƒã«æˆ»ã™
                changes[dateStr][periodIndex] = null;
                if (changes[dateStr].every(item => item === null)) {
                    delete changes[dateStr];
                }
            } else {
                // å¤‰æ›´ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹
                const schedule = getTimetableForDate(dateStr);
                changes[dateStr][periodIndex] = schedule[periodIndex] || '';
            }
            
            localStorage.setItem('timetableChanges', JSON.stringify(changes));
            displayDaySchedule();
        }
        
        // æ—¥åˆ¥è¡¨ç¤ºã§ã®æˆæ¥­å¤‰æ›´ä¿å­˜
        async function saveDayChange(dateStr, periodIndex) {
            const select = document.getElementById(`day_change_${periodIndex}`);
            if (!select) return;
            
            const changes = JSON.parse(localStorage.getItem('timetableChanges') || '{}');
            
            if (!changes[dateStr]) {
                changes[dateStr] = Array(periods).fill(null);
            }
            
            changes[dateStr][periodIndex] = select.value;
            
            localStorage.setItem('timetableChanges', JSON.stringify(changes));
            await saveToFirebase('changes', { changes: changes });
            
            alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
            displayDaySchedule();
        }
        
        // ãƒ¡ãƒ¢ã‚’ä¿å­˜
        async function saveMemo(dateStr, periodIndex) {
            const memoInput = document.getElementById(`memo_${periodIndex}`);
            if (!memoInput) return;
            
            const memos = JSON.parse(localStorage.getItem('classMemos') || '{}');
            const memoKey = `${dateStr}_${periodIndex}`;
            
            if (memoInput.value.trim() === '') {
                delete memos[memoKey];
            } else {
                memos[memoKey] = memoInput.value;
            }
            
            localStorage.setItem('classMemos', JSON.stringify(memos));
            await saveToFirebase('memos', { memos: memos });
        }
        
        // é€±é–“äºˆå®šã‚’è¡¨ç¤º
        function displayWeekSchedule() {
            const dateInput = document.getElementById('weekStartDate');
            let startDate = dateInput.value;
            
            if (!startDate) {
                alert('é€±ã®é–‹å§‹æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const [year, month, day] = startDate.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const dayOfWeek = date.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            date.setDate(date.getDate() + diff);
            
            const mondayYear = date.getFullYear();
            const mondayMonth = String(date.getMonth() + 1).padStart(2, '0');
            const mondayDay = String(date.getDate()).padStart(2, '0');
            startDate = `${mondayYear}-${mondayMonth}-${mondayDay}`;
            dateInput.value = startDate;
            
            const endDate = new Date(date.getFullYear(), date.getMonth(), date.getDate() + 4);
            const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
            const title = document.getElementById('weekDisplayTitle');
            title.textContent = `${startDate} ã€œ ${endDateStr}`;
            
            const table = document.getElementById('weekScheduleTable');
            table.innerHTML = '';
            
            const colors = JSON.parse(localStorage.getItem('classColors') || JSON.stringify(defaultColors));
            
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>æ™‚é™</th>';
            
            for (let i = 0; i < 5; i++) {
                const currentDate = new Date(date.getFullYear(), date.getMonth(), date.getDate() + i);
                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                const dayName = days[i];
                headerRow.innerHTML += `<th>${dayName}<br><span class="week-header">${dateStr}</span></th>`;
            }
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            const tbody = document.createElement('tbody');
            for (let period = 0; period < periods; period++) {
                const row = tbody.insertRow();
                const periodCell = row.insertCell(0);
                periodCell.textContent = `${period + 1}é™`;
                periodCell.className = 'period-cell';
                
                for (let day = 0; day < 5; day++) {
                    const currentDate = new Date(date.getFullYear(), date.getMonth(), date.getDate() + day);
                    const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                    const schedule = getTimetableForDate(dateStr);
                    const cls = schedule[period] || '';
                    
                    const cell = row.insertCell(day + 1);
                    
                    if (cls) {
                        const badge = document.createElement('div');
                        badge.className = 'class-badge';
                        badge.textContent = cls;
                        badge.style.background = colors[cls] || defaultColors[cls] || '#6c757d';
                        badge.style.fontSize = '12px';
                        badge.style.padding = '6px 10px';
                        cell.appendChild(badge);
                    } else {
                        cell.textContent = 'â€”';
                        cell.style.color = '#adb5bd';
                    }
                }
            }
            table.appendChild(tbody);
        }
        
        // è‰²è¨­å®šã®èª­ã¿è¾¼ã¿
        function loadColors() {
            const container = document.getElementById('colorSettings');
            container.innerHTML = '';
            
            const colors = JSON.parse(localStorage.getItem('classColors') || JSON.stringify(defaultColors));
            
            classes.slice(1).forEach(className => {
                const item = document.createElement('div');
                item.className = 'color-item';
                
                const label = document.createElement('label');
                label.textContent = `ã‚¯ãƒ©ã‚¹ ${className}`;
                
                const input = document.createElement('input');
                input.type = 'color';
                input.value = colors[className] || defaultColors[className];
                input.id = `color_${className}`;
                
                item.appendChild(label);
                item.appendChild(input);
                container.appendChild(item);
            });
        }
        
        // è‰²è¨­å®šã®ä¿å­˜
        async function saveColors() {
            const newColors = {};
            
            classes.slice(1).forEach(className => {
                const input = document.getElementById(`color_${className}`);
                if (input) {
                    newColors[className] = input.value;
                }
            });
            
            localStorage.setItem('classColors', JSON.stringify(newColors));
            await saveToFirebase('colors', { colors: newColors });
            showMessage('colorMessage');
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            if (currentView === 'day') {
                displayDaySchedule();
            } else if (currentView === 'week') {
                displayWeekSchedule();
            }
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(messageId) {
            const message = document.getElementById(messageId);
            message.classList.add('show');
            setTimeout(() => {
                message.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
